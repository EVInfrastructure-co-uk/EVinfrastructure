---
layout: default
title: "UK LAs — ORCS charging devices"
---

<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    #map {height:80vh;}
    .legend { background: white; padding: 6px 8px; font: 12px/1.5 sans-serif; box-shadow:0 0 8px rgba(0,0,0,0.2); }
    .legend .swatch { width:18px; height:12px; display:inline-block; margin-right:6px; vertical-align:middle; }
  </style>
</head>

<h1>Maps of local authorities</h1>

<div class="tabs js-tabs" data-module="tabs">
    <div class="tabs__controls" role="tablist" aria-label="Section">
      
      <button id="tab-near-home" class="tabs__tab tabs__tab--active" role="tab"
              aria-selected="true" aria-controls="near-home" tabindex="0">
        Public charging
      </button>

      <button id="tab-pavement-channels" class="tabs__tab" role="tab"
              aria-selected="false" aria-controls="pavement-channels" tabindex="-1">
        Pavement channels
      </button>

      <button id="tab-levi" class="tabs__tab" role="tab"
              aria-selected="false" aria-controls="levi" tabindex="-1">
        LEVI
      </button>

      <button id="tab-orcs" class="tabs__tab" role="tab"
              aria-selected="false" aria-controls="orcs" tabindex="-1">
        ORCS
      </button>

      <button id="tab-levi-pilot" class="tabs__tab" role="tab"
              aria-selected="false" aria-controls="levi-pilot" tabindex="-1">
        LEVI pilot
      </button>
    </div>

<div id="near-home" class="tabs__panel" role="tabpanel"
         aria-labelledby="tab-near-home">
</div>

<div id="pavement-channels" class="tabs__panel" role="tabpanel"
         aria-labelledby="tab-pavement-channels">
</div>

<div id="levi" class="tabs__panel" role="tabpanel"
         aria-labelledby="tab-levi">
</div>

<div id="orcs" class="tabs__panel" role="tabpanel"
         aria-labelledby="tab-orcs">

<h2>On-Street Charging Scheme (ORCS)</h2>

  <div id="map-orcs" aria-label="Map of UK local authorities coloured by ORCS charging devices (deciles)"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>
  <script src="https://unpkg.com/chroma-js@2.4.2/chroma.min.js"></script>

  <script>
  (async function () {
    // --- CONFIG: adjust these paths to where the files are hosted on your site ---
    const topojsonPath = '/government/local-government/data/LAD_DEC_24_UK_BSC_-416161531269609018.topojson';
    const eviJsonPath = '/government/local-government/data/uk_la_evi.json';
    const topoObjectName = 'LAD_DEC_24_UK_BSC_-416161531269609018';
    // --- END CONFIG ---

    const map = L.map('map-orcs').setView([54.5, -3], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Load TopoJSON
    const topo = await fetch(topojsonPath).then(r => {
      if (!r.ok) throw new Error('TopoJSON load failed: ' + r.status);
      return r.json();
    });
    const geojson = topojson.feature(topo, topo.objects[topoObjectName]);

    // Load EVI JSON
    const eviBundle = await fetch(eviJsonPath).then(r => {
      if (!r.ok) throw new Error('EVI JSON load failed: ' + r.status);
      return r.json();
    });

    // Find resource with the table rows
    const resource = (eviBundle.resources && eviBundle.resources.find(r => r.name === 'uk_local_authorities_current')) || (eviBundle.resources && eviBundle.resources[0]);
    if (!resource || !resource.data) throw new Error('Could not find resource.data in the EVI JSON');
    const rows = resource.data;

    // Build lookup: gss-code -> numeric ORCS-total-charging-devices
    const valueByGss = new Map();
    rows.forEach(row => {
      const gss = row['gss-code'];
      const val = row['ORCS-total-charging-devices'];
      const n = (val === null || val === undefined || val === '') ? NaN : Number(val);
      valueByGss.set(gss, n);
    });

    // Prepare list of numeric values (non-NaN)
    const values = Array.from(valueByGss.values()).filter(v => !isNaN(v)).sort((a,b)=>a-b);

    // quantile function (linear interpolation)
    function quantile(sortedArr, p) {
      if (!sortedArr.length) return NaN;
      const idx = (sortedArr.length - 1) * p;
      const lo = Math.floor(idx);
      const hi = Math.ceil(idx);
      if (hi === lo) return sortedArr[lo];
      const frac = idx - lo;
      return sortedArr[lo] * (1 - frac) + sortedArr[hi] * frac;
    }

    // Compute decile thresholds (9 thresholds dividing into 10 bins)
    let thresholds = [];
    if (values.length) {
      for (let i = 1; i <= 9; i++) {
        thresholds.push(quantile(values, i / 10));
      }
    }

    const min = values.length ? values[0] : 0;
    const max = values.length ? values[values.length - 1] : 1;

    // choose 10 colors (deciles) — change palette if you prefer
    const palette = chroma.scale('YlGnBu').mode('lab').colors(10);

    // Determine decile index 0..9 for a value
    function decileIndex(v) {
      if (isNaN(v)) return -1; // sentinel for no-data
      for (let i = 0; i < thresholds.length; i++) {
        if (v <= thresholds[i]) return i;
      }
      return 9;
    }

    // Style function uses decile bin color
    function style(feature) {
      const code = feature.properties && (feature.properties.LAD24CD || feature.properties.gss || feature.properties.gss_code);
      const v = valueByGss.get(code);
      const idx = decileIndex(v);
      return {
        weight: 1,
        color: '#444',
        opacity: 1,
        fillOpacity: idx === -1 ? 0.15 : 0.85,
        fillColor: idx === -1 ? '#cccccc' : palette[idx]
      };
    }

    // Add geo layer with hover tooltip
    const geoLayer = L.geoJSON(geojson, {
      style,
      onEachFeature: (feature, layer) => {
        const code = feature.properties && (feature.properties.LAD24CD || feature.properties.gss || feature.properties.gss_code);
        const name = feature.properties && (feature.properties.LAD24NM || feature.properties.name || 'Unknown');
        const v = valueByGss.get(code);
        layer.on({
          mouseover(e) {
            const target = e.target;
            target.setStyle({ weight: 2, color: '#000' });
            target.bringToFront();
            const html = `<strong>${name}</strong><br/>ORCS devices: ${isNaN(v) ? 'N/A' : v}`;
            target.bindTooltip(html, {sticky: true, direction: 'auto'}).openTooltip();
          },
          mouseout(e) {
            geoLayer.resetStyle(e.target);
            e.target.closeTooltip();
          },
          click(e) {
            map.fitBounds(e.target.getBounds(), { maxZoom: 12 });
          }
        });
      }
    }).addTo(map);

    // Legend: display decile swatches and ranges
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.setAttribute('role', 'group');
      div.setAttribute('aria-label', 'ORCS devices decile legend');

      if (!values.length) {
        div.innerHTML = '<strong>ORCS devices</strong><br/>No data';
        return div;
      }

      div.innerHTML = '<strong>ORCS devices (deciles)</strong><br/>';
      // Build ranges for display
      const rounded = v => (Math.round(v * 10) / 10).toLocaleString();
      let lower = min;
      for (let i = 0; i < 10; i++) {
        const color = palette[i];
        let upper;
        if (i < 9) upper = thresholds[i];
        else upper = max;
        const label = (i === 0)
          ? `${Math.round(lower)} – ${Math.round(upper)}`
          : `${Math.round(lower)} – ${Math.round(upper)}`;
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `<span class="swatch" style="background:${color}"></span> ${label}`;
        div.appendChild(row);
        lower = (i < 9) ? (thresholds[i] + Number.EPSILON) : (upper); // move lower bound forward slightly
      }
      // No data
      const nodatarow = document.createElement('div');
      nodatarow.className = 'row';
      nodatarow.style.marginTop = '6px';
      nodatarow.innerHTML = `<span class="swatch" style="background:#cccccc"></span> No data`;
      div.appendChild(nodatarow);
      return div;
    };
    legend.addTo(map);

  })().catch(err => {
    console.error(err);
    alert('Map initialization failed: ' + err.message);
  });
  </script>

</div>

<div id="levi-pilot" class="tabs__panel" role="tabpanel"
         aria-labelledby="tab-levi-pilot">
</div>

</div>