<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UK LAs â€” ORCS charging devices</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0; }
    #map { width:100vw; height:100vh; }
    .legend { background: white; padding: 6px 8px; font: 12px/1.5 sans-serif; box-shadow:0 0 8px rgba(0,0,0,0.2); }
    .legend .swatch { width:18px; height:12px; display:inline-block; margin-right:6px; vertical-align:middle; }
  </style>
</head>
<body>
  <div id="map" aria-label="Map of UK local authorities"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>
  <script src="https://unpkg.com/chroma-js@2.4.2/chroma.min.js"></script>

  <script>
  (async function () {
    // --- CONFIG: adjust these paths to where the files are hosted on your site ---
    const topojsonPath = '/government/local-government/data/LAD_DEC_24_UK_BSC_-416161531269609018.topojson';
    const eviJsonPath = '/government/local-government/data/uk_la_evi.json';
    // --- END CONFIG ---

    // Create map
    const map = L.map('map').setView([54.5, -3], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Load TopoJSON
    const topo = await fetch(topojsonPath).then(r => {
      if (!r.ok) throw new Error('TopoJSON load failed: ' + r.status);
      return r.json();
    });

    // The object name in this TopoJSON file (from your attached file)
    const topoObjectName = 'LAD_DEC_24_UK_BSC_-416161531269609018';
    const geojson = topojson.feature(topo, topo.objects[topoObjectName]);

    // Load your EVI JSON (the file you attached). It contains resources -> [ { data: [...] } ]
    const eviBundle = await fetch(eviJsonPath).then(r => {
      if (!r.ok) throw new Error('EVI JSON load failed: ' + r.status);
      return r.json();
    });

    // Find the table resource that includes the LA rows. Try by common resource name then fallback to first resource.
    const resource = (eviBundle.resources && eviBundle.resources.find(r => r.name === 'uk_local_authorities_current')) || (eviBundle.resources && eviBundle.resources[0]);
    if (!resource || !resource.data) throw new Error('Could not find resource.data in the EVI JSON');

    const rows = resource.data;

    // Build lookup: gss-code -> numeric ORCS-total-charging-devices
    const valueByGss = new Map();
    rows.forEach(row => {
      const gss = row['gss-code'];
      // parse numeric (may be null/undefined)
      const val = row['ORCS-total-charging-devices'];
      const n = (val === null || val === undefined || val === '') ? NaN : Number(val);
      valueByGss.set(gss, n);
    });

    // Prepare color scale using actual numeric values present
    const values = Array.from(valueByGss.values()).filter(v => !isNaN(v));
    const min = values.length ? Math.min(...values) : 0;
    const max = values.length ? Math.max(...values) : 1;
    // Use chroma scale - change palette as desired (colorblind friendly options available)
    const colorScale = chroma.scale(['#f7fbff','#6baed6','#08306b']).domain([min, max]);

    // Style & interactivity
    function style(feature) {
      const code = feature.properties && (feature.properties.LAD24CD || feature.properties.gss || feature.properties.gss_code);
      const v = valueByGss.get(code);
      const has = !isNaN(v);
      return {
        weight: 1,
        color: '#444',
        opacity: 1,
        fillOpacity: has ? 0.8 : 0.15,
        fillColor: has ? colorScale(v).hex() : '#cccccc'
      };
    }

    let geoLayer = L.geoJSON(geojson, {
      style,
      onEachFeature: (feature, layer) => {
        const code = feature.properties && (feature.properties.LAD24CD || feature.properties.gss || feature.properties.gss_code);
        const name = feature.properties && (feature.properties.LAD24NM || feature.properties.name || 'Unknown');
        const v = valueByGss.get(code);
        layer.on({
          mouseover(e) {
            const target = e.target;
            target.setStyle({ weight: 2, color: '#000' });
            target.bringToFront();
            const html = `<strong>${name}</strong><br/>ORCS devices: ${isNaN(v) ? 'N/A' : v}`;
            target.bindTooltip(html, {sticky: true, direction: 'auto'}).openTooltip();
          },
          mouseout(e) {
            geoLayer.resetStyle(e.target);
            e.target.closeTooltip();
          },
          click(e) {
            // optional: zoom to clicked LA
            map.fitBounds(e.target.getBounds(), { maxZoom: 12 });
          }
        });
      }
    }).addTo(map);

    // Add a simple legend
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      if (values.length === 0) {
        div.innerHTML = '<strong>ORCS devices</strong><br/>No data';
        return div;
      }
      const steps = 5;
      const stepVals = [];
      for (let i = 0; i <= steps; i++) {
        stepVals.push(min + (i / steps) * (max - min));
      }
      div.innerHTML = '<strong>ORCS devices</strong><br/>';
      for (let i = 0; i < stepVals.length - 1; i++) {
        const v = Math.round(stepVals[i]);
        const c = colorScale(stepVals[i] + 0.00001).hex();
        div.innerHTML += `<div><span class="swatch" style="background:${c}"></span> ${v}${i === stepVals.length - 2 ? '+' : ''}</div>`;
      }
      div.innerHTML += `<div style="margin-top:6px"><span class="swatch" style="background:#cccccc"></span> No data</div>`;
      return div;
    };
    legend.addTo(map);

  })().catch(err => {
    console.error(err);
    alert('Map initialization failed: ' + err.message);
  });
  </script>
</body>
</html>